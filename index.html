<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Template Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .tab-active {
            border-bottom: 3px solid #005A9C;
            font-weight: 600;
            color: #005A9C;
            padding-bottom: 8px;
        }
        .email-body-content {
            resize: none;
        }
        .package-item {
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Container -->
    <div class="p-4 sm:p-8">

        <!-- Header Tabs -->
        <div class="max-w-xl mx-auto flex justify-center space-x-8 mb-10 border-b border-gray-200">
            <div class="text-gray-500 cursor-pointer p-2 rounded-t-lg transition duration-150">Logo</div>
            <div class="tab-active cursor-pointer p-2 rounded-t-lg transition duration-150">Welcome Email</div>
            <div class="text-gray-500 cursor-pointer p-2 rounded-t-lg transition duration-150">Verifications</div>
        </div>

        <!-- Email Customization Card (Single Pane) -->
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg h-fit">
            
            <!-- Header and Action Buttons -->
            <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                <h1 class="text-2xl font-bold text-gray-800">Email Template Manager</h1>
                <div class="flex space-x-2">
                    <button onclick="createNewTemplate()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
                        + New Template
                    </button>
                    <button id="delete-template-btn" onclick="deleteActiveTemplate()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
                        Delete Template
                    </button>
                    <button onclick="saveChanges(true)" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 text-sm">
                        Save Template
                    </button>
                </div>
            </div>
            <p class="text-gray-500 mt-1 mb-6">Create, edit, and manage your reusable email template content below.</p>


            <!-- Template Selector -->
            <div class="mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <label for="template-selector" class="text-sm font-semibold text-gray-700 block mb-2">Active Template to Edit:</label>
                <select id="template-selector" onchange="handleTemplateSwitch(this.value)"
                    class="block w-full px-4 py-3 text-base text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 cursor-pointer">
                </select>
                <div class="mt-3 text-sm text-gray-600">Template ID: <span id="active-template-id" class="font-mono text-xs break-all text-gray-800">...</span></div>
            </div>
            
            <!-- Editable Fields -->
            <div class="space-y-6">
                
                <!-- Title Field (Editable input) -->
                <div>
                    <label class="text-sm font-semibold text-gray-700 block mb-1">Email Subject Title:</label>
                    <input type="text" id="email-title" class="p-3 w-full bg-white border border-gray-300 rounded-lg text-gray-800 font-medium shadow-inner focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Body Field (Editable textarea) -->
                <div>
                    <label class="text-sm font-semibold text-gray-700 block mb-1">Email Body Content:</label>
                    <textarea id="email-body" class="email-body-content p-4 w-full h-64 bg-white border border-gray-300 rounded-lg text-gray-800 shadow-inner overflow-y-auto focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Use {{applicant_name}} for personalization.</p>
                </div>
            </div>

            <!-- Package Assignment Management - Dual List with Buttons -->
            <div class="mt-10 pt-6 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Package Assignment</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Manually link or unlink packages to the active template. All unlinked packages default to the "Standard Welcome Template."
                </p>

                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Unassigned Packages List -->
                    <div class="md:w-1/2">
                        <h3 class="font-semibold text-gray-700 mb-2">Unassigned Packages</h3>
                        <div id="unassigned-packages-list" 
                             class="max-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-300 space-y-2">
                            <!-- Content will be rendered here -->
                        </div>
                    </div>
                    <!-- Packages Assigned to Current Template List -->
                    <div class="md:w-1/2">
                        <h3 class="font-semibold text-gray-700 mb-2">Packages Linked to Current Template</h3>
                        <div id="assigned-packages-list" 
                             class="max-h-80 overflow-y-auto p-3 bg-gray-100 rounded-lg border border-gray-300 space-y-2">
                            <!-- Content will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification for saving -->
        <div id="save-toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50">
            Changes saved successfully!
        </div>

    </div>

    <script>
        // --- Global Data Stores ---
        let activeTemplateId = '';
        let templates = {};
        let packages = {};
        let templateCounter = 1; 

        // --- Initial Package Data (Only used for initialization, not assignment) ---
        const initialPackageNames = {
            '6862631bb1f61ea810e0fb524': { name: 'ADP Fingerprint' },
            '66cdc1f849d72b50a3f7be33': { name: 'Add And Edit' },
            '650851b0fbd3d487d4e67aa50': { name: 'All OHS Checks' },
            '64a86ce44121b4497fd4286f5': { name: 'All Checks' },
            '64a7a1b1fafb428e4e72a31': { name: 'All Verification Checks' },
            '66c0eed3bbfb8fbb1c08158': { name: 'Aug28 Cc' },
            '6666c0fdf3ac7e1b8e393b3': { name: 'Auto PAA with Colorado Caps' },
            '65d72cb8c25491f3c25e871': { name: 'AutoPAA Dynamic Package' },
        };

        const defaultTemplateContent = {
            title: 'Bluetest Client Background Screening Invitation',
            body: `Hi {{applicant_name}},

**YOUR SCREENING INVITATION**
You have been invited by Bluetest Client to initiate your background screening process.
You will be asked to provide Vetty with the necessary information to conduct a background screening on behalf of Bluetest client.

**NEXT STEPS**
Please click the link below to accept the invitation and begin your screening process.

**SUPPORT & QUESTIONS**
If you have any questions about the screening process, please contact Bluetest client for further details.`
        };

        // --- 1. Persistence and Initialization ---

        function generateUniqueId() {
            return 'T' + String(templateCounter++).padStart(3, '0');
        }

        function initializeData() {
            const storedTemplates = JSON.parse(localStorage.getItem('emailTemplates'));
            const storedPackages = JSON.parse(localStorage.getItem('packageAssignments'));
            const storedCounter = localStorage.getItem('templateCounter');

            if (storedTemplates && Object.keys(storedTemplates).length > 0 && storedPackages) {
                templates = storedTemplates;
                packages = storedPackages;
                templateCounter = storedCounter ? parseInt(storedCounter) : Object.keys(templates).length + 1;
            } else {
                // Initial setup: Create one default template and map all packages to it
                const defaultId = generateUniqueId();
                templates[defaultId] = { name: 'Standard Welcome Template', title: defaultTemplateContent.title, body: defaultTemplateContent.body };
                
                for (const id in initialPackageNames) {
                    packages[id] = { name: initialPackageNames[id].name, templateId: defaultId };
                }
                saveAllData();
            }
        }

        function saveAllData() {
            localStorage.setItem('emailTemplates', JSON.stringify(templates));
            localStorage.setItem('packageAssignments', JSON.stringify(packages));
            localStorage.setItem('templateCounter', templateCounter);
        }

        // --- 2. UI Helper Functions ---

        function showToast(message, isError = false) {
            const toast = document.getElementById('save-toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function populateTemplateSelector() {
            const selector = document.getElementById('template-selector');
            selector.innerHTML = '';
            
            const templateIds = Object.keys(templates).sort();

            templateIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = templates[id].name;
                selector.appendChild(option);
            });
            
            if (!activeTemplateId && templateIds.length > 0) {
                activeTemplateId = templateIds[0];
            }
            selector.value = activeTemplateId;
        }
        
        // --- 3. Package Assignment Logic (Button-Based) ---

        function togglePackageAssignment(pkgId, action) {
            const defaultTemplateId = Object.keys(templates).sort()[0]; // T001 is always the global fallback
            const pkg = packages[pkgId];

            if (!pkg) {
                showToast("Package data not found.", true);
                return;
            }

            let newTemplateId = null;
            let successMessage = '';
            let isConfirm = true;

            if (action === 'link') {
                if (pkg.templateId === activeTemplateId) {
                    showToast(`Package is already linked to ${templates[activeTemplateId].name}.`, true);
                    return;
                }
                newTemplateId = activeTemplateId;
                successMessage = `Package linked to ${templates[activeTemplateId].name}.`;
            } else if (action === 'unlink') {
                if (activeTemplateId === defaultTemplateId) {
                    showToast(`Error: Cannot unlink packages from the **Standard Welcome Template**.`, true);
                    return;
                }
                if (pkg.templateId !== activeTemplateId) {
                    showToast(`Package is not currently linked to ${templates[activeTemplateId].name}.`, true);
                    return;
                }
                newTemplateId = defaultTemplateId; // Reassign to default
                successMessage = `Package unlinked and assigned to ${templates[defaultTemplateId].name}.`;
            }

            if (newTemplateId) {
                // If linking, no confirmation needed. If unlinking, ask for confirmation.
                if (action === 'link' || (action === 'unlink' && window.confirm(`Are you sure you want to UNLINK "${pkg.name}"? It will be reassigned to the default template.`))) {
                     pkg.templateId = newTemplateId;
                     saveAllData();
                     renderPackageAssignmentList();
                     showToast(successMessage);
                }
            }
        }

        function renderPackageAssignmentList() {
            const unassignedListEl = document.getElementById('unassigned-packages-list');
            const assignedListEl = document.getElementById('assigned-packages-list');
            unassignedListEl.innerHTML = '';
            assignedListEl.innerHTML = '';
            
            const packageIds = Object.keys(packages).sort((a, b) => packages[a].name.localeCompare(packages[b].name));
            
            packageIds.forEach(pkgId => {
                const pkg = packages[pkgId];
                const isAssigned = pkg.templateId === activeTemplateId;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `package-item ${isAssigned ? 'bg-blue-100' : 'bg-white'} border border-gray-300`;

                itemDiv.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${pkg.name}</span>
                        <span class="text-xs text-gray-500 block">ID: ${pkgId.substring(0, 8)}...</span>
                    </div>
                    <div>
                        ${isAssigned 
                            ? `<button onclick="togglePackageAssignment('${pkgId}', 'unlink')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold py-1 px-2 rounded-lg transition duration-150">Unlink</button>`
                            : `<button onclick="togglePackageAssignment('${pkgId}', 'link')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-2 rounded-lg transition duration-150">Link</button>`
                        }
                    </div>
                `;
                
                if (isAssigned) {
                    assignedListEl.appendChild(itemDiv);
                } else {
                    unassignedListEl.appendChild(itemDiv);
                }
            });
            
            // Add messages for empty lists
            if (unassignedListEl.children.length === 0) {
                unassignedListEl.innerHTML = '<p class="text-sm text-gray-500 p-2 text-center">All packages are linked to a template.</p>';
            }
            if (assignedListEl.children.length === 0) {
                assignedListEl.innerHTML = '<p class="text-sm text-gray-500 p-2 text-center">No packages are linked to this template.</p>';
            }
        }


        // --- 4. Template and Package Logic ---

        function loadTemplate(templateId) {
            const template = templates[templateId];
            
            document.getElementById('email-title').value = template.name || template.title; 
            document.getElementById('email-body').value = template.body;
            document.getElementById('active-template-id').textContent = templateId;

            document.getElementById('delete-template-btn').disabled = Object.keys(templates).length <= 1;

            renderPackageAssignmentList(); // Refresh the assignment lists
        }

        function saveChanges(showToastMsg = false) {
            if (!activeTemplateId) return;

            const newName = document.getElementById('email-title').value || 'Untitled Template';
            const newBody = document.getElementById('email-body').value;

            if (templates[activeTemplateId]) {
                templates[activeTemplateId].name = newName;
                templates[activeTemplateId].title = newName; 
                templates[activeTemplateId].body = newBody;
                saveAllData();
                if (showToastMsg) showToast(`Template "${newName}" saved successfully!`);
                populateTemplateSelector(); 
            }
        }
        
        function handleTemplateSwitch(newTemplateId) {
            saveChanges(false); 
            activeTemplateId = newTemplateId;
            loadTemplate(newTemplateId);
        }

        function createNewTemplate() {
            saveChanges(false);
            const newId = generateUniqueId();
            const newName = `New Template ${templateCounter - 1}`;
            templates[newId] = { 
                name: newName, 
                title: `${newName} Subject`,
                body: "Hi {{applicant_name}},\n\nThis is a brand new template. Edit the title and body, and save."
            };
            saveAllData();
            
            activeTemplateId = newId;
            populateTemplateSelector();
            loadTemplate(newId);
            showToast(`Template "${newName}" created.`);

            // Focus and select the title field
            const titleInput = document.getElementById('email-title');
            titleInput.focus();
            titleInput.select();
        }

        function deleteActiveTemplate() {
            if (Object.keys(templates).length <= 1) {
                showToast("Cannot delete the last remaining template.", true);
                return;
            }

            const confirmDelete = window.confirm(`Are you sure you want to delete template "${templates[activeTemplateId].name}"? All assigned packages will be moved to the default template.`);
            if (!confirmDelete) return;

            const deletedId = activeTemplateId;
            const remainingIds = Object.keys(templates).filter(id => id !== deletedId);
            const reassignmentId = remainingIds[0]; // The default/fallback template

            // 1. Reassign packages
            for (const pkgId in packages) {
                if (packages[pkgId].templateId === deletedId) {
                    packages[pkgId].templateId = reassignmentId;
                }
            }
            
            delete templates[deletedId];

            activeTemplateId = reassignmentId;
            saveAllData();
            populateTemplateSelector();
            loadTemplate(reassignmentId);
            showToast(`Template deleted. Packages reassigned to "${templates[reassignmentId].name}".`);
        }


        // --- 5. Initialization ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            initializeData();
            populateTemplateSelector();
            if (activeTemplateId) {
                loadTemplate(activeTemplateId);
            }
        }
    </script>

</body>
</html>
